# –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—Ä–µ–π—Ñ–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ (Drift Protection)

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–í —Å–∏—Å—Ç–µ–º–∞—Ö –ø–æ–¥—Å—á–µ—Ç–∞ –ª—é–¥–µ–π –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å **–¥—Ä–µ–π—Ñ —Å—á–µ—Ç—á–∏–∫–æ–≤** (drift) ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ occupancy —É—Ö–æ–¥–∏—Ç –≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

### –ü—Ä–∏—á–∏–Ω—ã –¥—Ä–µ–π—Ñ–∞:

1. **–ü—Ä–æ–ø—É—Å–∫ –Ω–∞ –≤—Ö–æ–¥–µ** ‚Äî —á–µ–ª–æ–≤–µ–∫ –±—ã–ª –ø–µ—Ä–µ–∫—Ä—ã—Ç –¥—Ä—É–≥–∏–º –æ–±—ä–µ–∫—Ç–æ–º –ø—Ä–∏ –≤—Ö–æ–¥–µ
2. **–õ–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –≤—ã—Ö–æ–¥–µ** ‚Äî —Ç—Ä–µ–∫–µ—Ä –æ—à–∏–±–æ—á–Ω–æ –∑–∞—Å—á–∏—Ç–∞–ª –≤—ã—Ö–æ–¥
3. **–ü–æ—Ç–µ—Ä—è —Ç—Ä–µ–∫–∞** ‚Äî –æ–±—ä–µ–∫—Ç –ø–æ—Ç–µ—Ä—è–ª ID –∏ –ø–æ–ª—É—á–∏–ª –Ω–æ–≤—ã–π –ø—Ä–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ –ª–∏–Ω–∏–∏
4. **–û–∫–∫–ª—é–∑–∏—è** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤

### –ü—Ä–∏–º–µ—Ä:

```
–í—Ö–æ–¥: 5 —á–µ–ª–æ–≤–µ–∫ (–Ω–æ —Ç—Ä–µ–∫–µ—Ä –∑–∞—Å—á–∏—Ç–∞–ª —Ç–æ–ª—å–∫–æ 4)
–í—ã—Ö–æ–¥: 5 —á–µ–ª–æ–≤–µ–∫ (—Ç—Ä–µ–∫–µ—Ä –∑–∞—Å—á–∏—Ç–∞–ª –≤—Å–µ 5)
–†–µ–∑—É–ª—å—Ç–∞—Ç: occupancy = 4 - 5 = -1 ‚ùå
```

## üõ°Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞

### 1. –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ C++ (`main.cpp`)

```cpp
// –í—ã—á–∏—Å–ª—è–µ–º –∑–∞–Ω—è—Ç–æ—Å—Ç—å
int occupancy = count_in - count_out;
int corrected_occupancy = std::max(0, occupancy); // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö

// –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
cv::Scalar occupancy_color = (occupancy < 0) ? cv::Scalar(0, 165, 255) : cv::Scalar(255, 255, 255);
std::string occupancy_text = "INSIDE: " + std::to_string(corrected_occupancy);
if (occupancy < 0) {
    occupancy_text += " (!" + std::to_string(occupancy) + ")";
}
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**

- –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: `INSIDE: 5` (–±–µ–ª—ã–π —Ç–µ–∫—Å—Ç)
- –î—Ä–µ–π—Ñ: `INSIDE: 0 (!-2)` (–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ç–µ–∫—Å—Ç)

### 2. –ó–∞—â–∏—Ç–∞ –≤ –¥–∞—à–±–æ—Ä–¥–µ (`dashboard/app.py`)

```python
# –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
corrected_occupancy = max(0, current_occupancy)
has_drift = current_occupancy < 0

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
if has_drift:
    col3.metric(
        "üè¢ INSIDE",
        f"{corrected_occupancy} ‚ö†Ô∏è",
        delta=f"Drift: {current_occupancy}",
        delta_color="inverse"
    )
    st.warning("‚ö†Ô∏è Tracker drift detected...")
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**

- –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: `INSIDE: 0 ‚ö†Ô∏è (Drift: -2)`
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã

### 3. –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ **üîÑ Reset Counters** –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –¥–∞—à–±–æ—Ä–¥–∞:

```python
if st.button("üîÑ Reset Counters"):
    cursor.execute("DELETE FROM people_count")
    st.success("‚úÖ Counters reset successfully!")
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û—Ö—Ä–∞–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –≤ –Ω–∞—á–∞–ª–µ —Å–º–µ–Ω—ã –∏–ª–∏ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥—Ä–µ–π—Ñ–∞.

## üìä –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥—Ä–µ–π—Ñ–∞

–î—Ä–µ–π—Ñ –≤–∏–¥–µ–Ω –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ **Occupancy Over Time**:

- –†–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏ –≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é –∑–æ–Ω—É
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ occupancy –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –≤—ã—Ö–æ–¥–æ–≤

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –¥—Ä–µ–π—Ñ–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–∫–µ—Ä–∞

```cpp
// –£–≤–µ–ª–∏—á–∏—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
SimpleTracker tracker(max_frames_missing = 10, distance_threshold = 80);

// –ë–æ–ª—å—à–µ —Ç–µ—Ä–ø–∏–º–æ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–º –∫–∞–¥—Ä–∞–º
```

### 2. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏ –ø–æ–¥—Å—á–µ—Ç–∞

- ‚úÖ –õ–∏–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∞ –ø–æ—Ç–æ–∫—É –¥–≤–∏–∂–µ–Ω–∏—è
- ‚úÖ –ò–∑–±–µ–≥–∞—Ç—å —É–∑–∫–∏—Ö –ø—Ä–æ—Ö–æ–¥–æ–≤ —Å –æ–∫–∫–ª—é–∑–∏–µ–π
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
- ‚ùå –ù–µ —Å—Ç–∞–≤–∏—Ç—å –ª–∏–Ω–∏—é –≤ –∑–æ–Ω–∞—Ö –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª—é–¥–µ–π

### 3. –£–ª—É—á—à–µ–Ω–∏–µ –¥–µ—Ç–µ–∫—Ü–∏–∏

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å (YOLOv8m/l –≤–º–µ—Å—Ç–æ s)
- –°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç—Ä—É–¥–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- –î–æ–±–∞–≤–∏—Ç—å Re-ID (re-identification) –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤

### 4. –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞

```python
# –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
if hour == 6 and minute == 0:  # 6:00 —É—Ç—Ä–∞
    reset_counters()  # –°–±—Ä–æ—Å –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–Ω—è
```

## üéì –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ñ–µ—Å—Ç–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (Simple)

```cpp
occupancy = std::max(0, count_in - count_out);
```

- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚ùå –¢–µ—Ä—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥—Ä–µ–π—Ñ–µ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä–µ–π—Ñ–∞ (Monitoring)

```cpp
if (occupancy < 0) {
    log_drift_event(occupancy, timestamp);
    occupancy = 0;
}
```

- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ú–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞

### –í–∞—Ä–∏–∞–Ω—Ç 3: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (Advanced)

```cpp
// –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏ –¥–∞—Ç—á–∏–∫–∞–º–∏ (—Ç—É—Ä–Ω–∏–∫–µ—Ç—ã, –≤–µ—Å—ã)
if (abs(tracker_occupancy - sensor_occupancy) > threshold) {
    trigger_recalibration();
}
```

- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ (Smart)

```cpp
// –ö–∞–∂–¥—ã–π —á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É—Å—Ç–∞ –ª–∏ –∑–æ–Ω–∞
if (is_calibration_time() && zone_is_empty_by_sensor()) {
    count_in = 0;
    count_out = 0;
}
```

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

–î–ª—è –æ—Ü–µ–Ω–∫–∏ –¥—Ä–µ–π—Ñ–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```python
# –°—Ä–µ–¥–Ω–∏–π –¥—Ä–µ–π—Ñ –∑–∞ –¥–µ–Ω—å
avg_drift = df[df['occupancy'] < 0]['occupancy'].mean()

# –ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–∏—Å–µ–π —Å –¥—Ä–µ–π—Ñ–æ–º
drift_percentage = (df['occupancy'] < 0).sum() / len(df) * 100

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥—Ä–µ–π—Ñ
max_drift = df['occupancy'].min()
```

**–¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**

- `drift_percentage < 5%` ‚Äî –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- `drift_percentage < 15%` ‚Äî –ü—Ä–∏–µ–º–ª–µ–º–æ
- `drift_percentage > 20%` ‚Äî –¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ —Ç—Ä–µ–∫–∏–Ω–≥–∞

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å** ‚Äî –ø–æ –¥–∞—Ç—á–∏–∫–∞–º –∏–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥—Ä–µ–π—Ñ–∞** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
3. **–£–º–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
4. **Re-ID –º–æ–¥—É–ª—å** ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É –≤–∏–¥—É
5. **Multi-line counting** ‚Äî –ø–æ–¥—Å—á–µ—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ª–∏–Ω–∏—è—Ö –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## üìù Changelog

### v2.1 - Drift Protection

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π occupancy
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥—Ä–µ–π—Ñ–µ –≤ C++ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∞ –¥—Ä–µ–π—Ñ–∞ –≤ –¥–∞—à–±–æ—Ä–¥–µ
- ‚úÖ –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—é –∏ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –¥—Ä–µ–π—Ñ–∞
