#!/usr/bin/env bash
# Smart-Counter Task Runner - Makefile alternative
# Usage: ./run TASK [args]

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${PROJECT_ROOT}"

case "${1:-help}" in
    # Setup and initialization
    setup)
        echo -e "${BLUE}Running MLOps setup...${NC}"
        ./scripts/setup_mlops.sh
        ;;
    
    setup-server)
        echo -e "${BLUE}Running server setup (non-interactive)...${NC}"
        DEPLOY_MODE=server SKIP_INTERACTIVE=true ./scripts/setup_mlops.sh
        ;;
    
    setup-docker)
        echo -e "${BLUE}Running Docker setup...${NC}"
        DEPLOY_MODE=docker ./scripts/setup_mlops.sh
        ;;
    
    # Build tasks
    build)
        echo -e "${BLUE}Building C++ project...${NC}"
        ./scripts/build.sh
        ;;
    
    build-docker)
        echo -e "${BLUE}Building Docker image...${NC}"
        ./scripts/deploy.sh build
        ;;
    
    # Run tasks
    run)
        echo -e "${BLUE}Running application...${NC}"
        ./scripts/run.sh "$@"
        ;;
    
    run-docker)
        echo -e "${BLUE}Running in Docker with display...${NC}"
        ./scripts/deploy.sh run --gpu --display
        ;;
    
    run-docker-cpu)
        echo -e "${BLUE}Running in Docker (CPU only) with display...${NC}"
        ./scripts/deploy.sh run --cpu --display
        ;;
    
    run-docker-headless)
        echo -e "${BLUE}Running in Docker (headless)...${NC}"
        ./scripts/deploy.sh run --gpu
        ;;
    
    # Docker Compose tasks
    compose-up)
        echo -e "${BLUE}Starting services with docker-compose...${NC}"
        docker compose up -d
        ;;
    
    compose-down)
        echo -e "${BLUE}Stopping services with docker-compose...${NC}"
        docker compose down
        ;;
    
    compose-logs)
        echo -e "${BLUE}Showing docker-compose logs...${NC}"
        docker compose logs -f "${2:-}"
        ;;
    
    compose-restart)
        echo -e "${BLUE}Restarting services with docker-compose...${NC}"
        docker compose restart "${2:-}"
        ;;
    
    compose-build)
        echo -e "${BLUE}Building services with docker-compose...${NC}"
        docker compose build
        ;;
    
    # Deployment
    deploy)
        echo -e "${BLUE}Deploying as service...${NC}"
        ./scripts/deploy.sh deploy
        ;;
    
    stop)
        echo -e "${BLUE}Stopping service...${NC}"
        ./scripts/deploy.sh stop
        ;;
    
    # Monitoring
    status)
        echo -e "${BLUE}Checking status...${NC}"
        ./scripts/deploy.sh status
        ;;
    
    logs)
        echo -e "${BLUE}Showing logs...${NC}"
        ./scripts/deploy.sh logs
        ;;
    
    # Utilities
    check-cuda)
        echo -e "${BLUE}Checking CUDA setup...${NC}"
        ./scripts/check_cuda.sh
        ;;
    
    shell)
        echo -e "${BLUE}Opening container shell...${NC}"
        ./scripts/deploy.sh shell
        ;;
    
    clean)
        echo -e "${BLUE}Cleaning up...${NC}"
        ./scripts/deploy.sh clean
        rm -rf build/
        echo -e "${GREEN}âœ… Cleanup complete${NC}"
        ;;
    
    test)
        echo -e "${BLUE}Running tests...${NC}"
        if [ -d "build" ]; then
            cd build && ctest --output-on-failure
        else
            echo -e "${YELLOW}Build directory not found. Run './run build' first${NC}"
        fi
        ;;
    
    # Help
    help|--help|-h)
        echo -e "${GREEN}Smart-Counter Task Runner${NC}"
        echo ""
        echo -e "${YELLOW}Setup Commands:${NC}"
        echo "  setup              Interactive setup (local development)"
        echo "  setup-server       Non-interactive setup (for servers)"
        echo "  setup-docker       Setup for Docker deployment"
        echo ""
        echo -e "${YELLOW}Build Commands:${NC}"
        echo "  build              Build C++ project locally"
        echo "  build-docker       Build Docker image"
        echo ""
        echo -e "${YELLOW}Run Commands:${NC}"
        echo "  run                Run application locally"
        echo "  run-docker         Run in Docker with GPU (with display)"
        echo "  run-docker-cpu     Run in Docker with CPU only (with display)"
        echo "  run-docker-headless Run in Docker headless (no display)"
        echo ""
        echo -e "${YELLOW}Docker Compose Commands:${NC}"
        echo "  compose-up         Start all services with docker-compose"
        echo "  compose-down       Stop all services with docker-compose"
        echo "  compose-logs       Show logs (optionally specify service: detector/dashboard)"
        echo "  compose-restart    Restart services (optionally specify service)"
        echo "  compose-build      Build all services with docker-compose"
        echo ""
        echo -e "${YELLOW}Deployment Commands:${NC}"
        echo "  deploy             Deploy as persistent service"
        echo "  stop               Stop running service"
        echo ""
        echo -e "${YELLOW}Monitoring Commands:${NC}"
        echo "  status             Check service status"
        echo "  logs               Show service logs"
        echo "  check-cuda         Verify CUDA installation"
        echo ""
        echo -e "${YELLOW}Utility Commands:${NC}"
        echo "  shell              Open shell in running container"
        echo "  clean              Clean build artifacts and containers"
        echo "  test               Run tests"
        echo "  help               Show this help message"
        echo ""
        echo -e "${YELLOW}Examples:${NC}"
        echo "  ./run setup                                    # Initial setup"
        echo "  ./run build                                    # Build project"
        echo "  ./run run-docker                               # Run with GPU and display"
        echo "  ./run compose-up                               # Start with docker-compose"
        echo "  ./run compose-logs detector                    # Show detector logs"
        echo "  ./run compose-down                             # Stop docker-compose"
        echo "  ./run deploy                                   # Deploy as service"
        echo "  ./run logs                                     # Monitor logs"
        echo ""
        echo -e "${YELLOW}Advanced Usage (with custom paths):${NC}"
        echo "  # Run with custom input video"
        echo "  sudo docker run --rm -it --gpus all --display \\"
        echo "    -e DISPLAY=\$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix \\"
        echo "    -v \$(pwd)/my_video.mp4:/app/input.mp4 \\"
        echo "    smart-counter-cpp \\"
        echo "    bash -c './build/SmartCounter --input /app/input.mp4 --display'"
        echo ""
        echo "  # Or use the deploy script directly"
        echo "  ./scripts/deploy.sh run --input my_video.mp4 --output result.mp4 --display"
        echo ""
        echo -e "${YELLOW}Server Quick Start:${NC}"
        echo "  git clone <repo> && cd Smart-Counter"
        echo "  ./run setup-server"
        echo "  ./run build-docker"
        echo "  ./run deploy"
        echo ""
        ;;
    
    *)
        echo -e "${YELLOW}Unknown task: $1${NC}"
        echo "Run './run help' for available commands"
        exit 1
        ;;
esac
